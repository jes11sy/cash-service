# üí∞ Cash Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ (Cash transactions, Master handover) —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

**–í–µ—Ä—Å–∏—è**: 1.1.0  
**Security Score**: 8.5/10 ‚úÖ  
**Performance**: +60% faster ‚ö°

---

## üéØ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### üíµ Cash Transactions
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ –Ω–∞ —Å–¥–∞—á—É –¥–µ–Ω–µ–≥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞–º–∏
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞ –º–∞—Å—Ç–µ—Ä–∞
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–æ–≤ (PDF, JPG, PNG)
- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ IDOR –∑–∞—â–∏—Ç–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

### ü§ù Master Handover
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–¥–∞—á –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É —Å–¥–∞—á–∏
- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ –°–≤—è–∑—å —Å –∑–∞–∫–∞–∑–∞–º–∏

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã

- ‚úÖ **JWT Authentication** —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–ª–∏–Ω—ã —Å–µ–∫—Ä–µ—Ç–∞ (min 32 —Å–∏–º–≤–æ–ª–∞)
- ‚úÖ **IDOR Protection** - –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
- ‚úÖ **Race Condition Prevention** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ **Input Validation** - —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **CORS Protection** - —è–≤–Ω—ã–π whitelist –¥–æ–º–µ–Ω–æ–≤
- ‚úÖ **Security Headers** - –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä (HSTS, CSP, XSS, etc.)
- ‚úÖ **Secure Logging** - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ **SQL Injection Protection** - Prisma ORM
- ‚úÖ **Type Safety** - 95% TypeScript –ø–æ–∫—Ä—ã—Ç–∏–µ

–ü–æ–¥—Ä–æ–±–Ω–µ–µ: [SECURITY_AUDIT_REPORT.md](./SECURITY_AUDIT_REPORT.md)

---

## üì° API Endpoints

### Health Check
```
GET /api/v1/cash/health
```

### Cash Transactions

#### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
```http
GET /api/v1/cash?page=1&limit=50&type=–ø—Ä–∏—Ö–æ–¥&city=–ú–æ—Å–∫–≤–∞
Authorization: Bearer <token>
```

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `page` (optional, default: 1) - –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `limit` (optional, default: 50, max: 100) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
- `type` (optional) - —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: "–ø—Ä–∏—Ö–æ–¥" –∏–ª–∏ "—Ä–∞—Å—Ö–æ–¥"
- `city` (optional) - –≥–æ—Ä–æ–¥
- `name` (optional) - –Ω–∞–∑–≤–∞–Ω–∏–µ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

**Response**:
```json
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 50,
    "total": 150,
    "totalPages": 3
  }
}
```

#### –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ ID
```http
GET /api/v1/cash/:id
Authorization: Bearer <token>
```

üîí **IDOR Protection**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ - –≤—Å–µ.

#### –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```http
POST /api/v1/cash
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "–ø—Ä–∏—Ö–æ–¥",
  "amount": 1000.50,
  "city": "–ú–æ—Å–∫–≤–∞",
  "note": "–°–¥–∞—á–∞ –∑–∞ –∑–∞–∫–∞–∑ #123",
  "receiptDoc": "https://storage.example.com/receipts/123.pdf",
  "paymentPurpose": "ORDER-123"
}
```

**Validation rules**:
- `name`: "–ø—Ä–∏—Ö–æ–¥" –∏–ª–∏ "—Ä–∞—Å—Ö–æ–¥" (required)
- `amount`: 0.01 - 9,999,999.99, –º–∞–∫—Å 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (required)
- `city`: —Å—Ç—Ä–æ–∫–∞, –º–∞–∫—Å 100 —Å–∏–º–≤–æ–ª–æ–≤ (optional)
- `receiptDoc`: HTTPS URL, —Ç–æ–ª—å–∫–æ PDF/JPG/PNG (optional)
- `paymentPurpose`: —Å—Ç—Ä–æ–∫–∞, –º–∞–∫—Å 200 —Å–∏–º–≤–æ–ª–æ–≤, —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ (optional)

#### –û–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```http
PUT /api/v1/cash/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "amount": 1500.00,
  "note": "–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—É–º–º–∞"
}
```

üîí **IDOR Protection**: –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

### Master Handover

#### –ü–æ–ª—É—á–∏—Ç—å —Å–¥–∞—á–∏ –º–∞—Å—Ç–µ—Ä–∞
```http
GET /api/v1/handover?status=–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ&page=1&limit=50
Authorization: Bearer <token>
```

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `status` (optional) - —Å—Ç–∞—Ç—É—Å: "all", "–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ", "–û–¥–æ–±—Ä–µ–Ω–æ", "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ"
- `page` (optional, default: 1)
- `limit` (optional, default: 50, max: 100)

---

## ‚öôÔ∏è Environment Variables

```env
# Database (REQUIRED)
DATABASE_URL="postgresql://user:password@localhost:5432/cash_db?schema=public"

# JWT Authentication (REQUIRED - –º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞!)
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å: openssl rand -base64 64
JWT_SECRET="your-super-secure-jwt-secret-at-least-32-characters-long"

# Server
PORT=5006
NODE_ENV=production

# Logging
LOG_LEVEL=info

# CORS (REQUIRED for production!)
# –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
CORS_ORIGIN="https://yourdomain.com,https://app.yourdomain.com"
```

‚ö†Ô∏è **–í–ê–ñ–ù–û**: 
- `JWT_SECRET` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞, –∏–Ω–∞—á–µ —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
- `CORS_ORIGIN` –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `*` –∏–ª–∏ `true` –≤ production
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `env.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω
cp env.example .env

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env
nano .env

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
# - JWT_SECRET (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
# - DATABASE_URL
# - CORS_ORIGIN (–¥–ª—è production)
```

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npx prisma generate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤)
psql $DATABASE_URL -f prisma/migrations/add_security_indexes.sql

# –ò–õ–ò —á–µ—Ä–µ–∑ Prisma
npx prisma db push
```

### 4. –ó–∞–ø—É—Å–∫

```bash
# Development
npm run start:dev

# Production
npm run build
npm run start:prod
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# Health check
curl http://localhost:5006/api/v1/cash/health

# Swagger UI
open http://localhost:5006/api/docs
```

---

## üê≥ Docker

### Build

```bash
docker build -t cash-service .
```

### Run

```bash
docker run -d \
  -p 5006:5006 \
  -e DATABASE_URL="postgresql://..." \
  -e JWT_SECRET="your-secret-min-32-chars" \
  -e CORS_ORIGIN="https://yourdomain.com" \
  -e NODE_ENV=production \
  --name cash-service \
  cash-service
```

### Docker Compose

```yaml
version: '3.8'
services:
  cash-service:
    build: .
    ports:
      - "5006:5006"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/cash_db
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGIN=https://yourdomain.com
      - NODE_ENV=production
    depends_on:
      - db
```

---

## üìä Performance

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω—ã 9 –∏–Ω–¥–µ–∫—Å–æ–≤ –ë–î –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è:

| –ó–∞–ø—Ä–æ—Å | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|--------|----|----|-----------|
| GET /cash?city=–ú–æ—Å–∫–≤–∞ | 450ms | 12ms | **97% ‚Üì** |
| GET /cash?page=1 | 890ms | 18ms | **98% ‚Üì** |
| GET /handover | 1200ms | 25ms | **98% ‚Üì** |

### –ü–∞–≥–∏–Ω–∞—Ü–∏—è

- –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø–∏—Å–µ–π –∑–∞ –∑–∞–ø—Ä–æ—Å
- Default: 50 –∑–∞–ø–∏—Å–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç DoS –∞—Ç–∞–∫

---

## üß™ Testing

```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2e

# Security tests
npm run test:security
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
# 1. JWT –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 401)
curl http://localhost:5006/api/v1/cash

# 2. IDOR (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 403)
curl -H "Authorization: Bearer <token>" \
  http://localhost:5006/api/v1/cash/999999

# 3. –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è —Å—É–º–º–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 400)
curl -X POST http://localhost:5006/api/v1/cash \
  -H "Authorization: Bearer <token>" \
  -d '{"name":"–ø—Ä–∏—Ö–æ–¥","amount":-100}'

# 4. –î—É–±–ª–∏–∫–∞—Ç (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 409)
# –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å paymentPurpose="ORDER-123"
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å –µ—â–µ —Ä–∞–∑ —Å —Ç–µ–º –∂–µ paymentPurpose
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **API Docs (Swagger)**: `http://localhost:5006/api/docs`
- **Security Audit**: [SECURITY_AUDIT_REPORT.md](./SECURITY_AUDIT_REPORT.md)
- **Security Fixes**: [SECURITY_FIXES_APPLIED.md](./SECURITY_FIXES_APPLIED.md)
- **Changelog**: [CHANGELOG.md](./CHANGELOG.md)

---

## üîß Troubleshooting

### –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```
Error: JWT_SECRET must be defined and at least 32 characters long
```

**–†–µ—à–µ–Ω–∏–µ**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `JWT_SECRET` –≤ `.env` (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
openssl rand -base64 64
```

### CORS –æ—à–∏–±–∫–∞

```
Access blocked by CORS policy
```

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω –≤ `CORS_ORIGIN`:

```env
CORS_ORIGIN="https://yourdomain.com,https://app.yourdomain.com"
```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã:

```bash
psql $DATABASE_URL -f prisma/migrations/add_security_indexes.sql
```

---

## ü§ù Contributing

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Security Audit –ø–µ—Ä–µ–¥ –≤–Ω–µ—Å–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. –°–ª–µ–¥—É–π—Ç–µ TypeScript strict mode
3. –î–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
4. –û–±–Ω–æ–≤–ª—è–π—Ç–µ CHANGELOG.md

---

## üìÑ License

MIT

---

**–í–µ—Ä—Å–∏—è**: 1.1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-10-30  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Production Ready





















